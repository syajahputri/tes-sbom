name: CI Security Pipeline - SBOM & Vulnerability Scan

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  security-events: write
  actions: read

env:
  PROJECT_PATH: '.'                     # ROOT repo
  SOLUTION_NAME: 'Appointment.sln'      # Solution di root

jobs:
  secure-build-pipeline:
    name: Build, Generate SBOM, and Scan
    runs-on: ubuntu-latest

    steps:
    # ------------------------------------------------------------------
    # TAHAP 1: PREPARATION
    # ------------------------------------------------------------------
    - name: Checkout Source Code
      uses: actions/checkout@v4

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          6.0.x
          2.1.x

    # ------------------------------------------------------------------
    # TAHAP 2: RESTORE & BUILD (NON-BLOCKING)
    # ------------------------------------------------------------------
    - name: Restore Dependencies
      run: dotnet restore ${{ env.SOLUTION_NAME }}
      continue-on-error: true

    - name: Build Application (Release)
      run: dotnet build ${{ env.SOLUTION_NAME }} -c Release --no-restore
      continue-on-error: true

    # ------------------------------------------------------------------
    # TAHAP 3: SBOM GENERATION (SYFT)
    # Scan dari SOURCE ROOT agar baca .sln & .csproj
    # ------------------------------------------------------------------
    - name: Generate SBOM (Syft)
      uses: anchore/sbom-action@v0
      id: syft-step
      with:
        path: ${{ env.PROJECT_PATH }}
        format: cyclonedx-json
        output-file: sbom.json
        dependency-snapshot: true

    - name: Upload SBOM Artifact
      uses: actions/upload-artifact@v4
      with:
        name: sbom-cyclonedx
        path: sbom.json
        retention-days: 5

    # ------------------------------------------------------------------
    # TAHAP 4: VULNERABILITY SCANNING (GRYPE - CLI)
    # ------------------------------------------------------------------
    - name: Install Grype
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh \
        | sh -s -- -b /usr/local/bin
    
    - name: Scan SBOM with Grype (Table)
      run: |
        grype sbom.json -o table || true
    
    - name: Generate SARIF Report (Grype)
      run: |
        grype sbom.json -o sarif > results.sarif || true
    
    - name: Upload Vulnerability Report (SARIF)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: results.sarif
        category: grype-sbom


    # ------------------------------------------------------------------
    # TAHAP 5: SECURITY GATE (SIMULASI KONTROL)
    # ------------------------------------------------------------------
    - name: Security Gate Check
      run: |
        echo "üîç Checking for High/Critical Vulnerabilities..."
    
        set +e
        grype sbom.json --fail-on high > pipeline_log.txt
        GRYPE_EXIT_CODE=$?
        set -e
    
        if [ $GRYPE_EXIT_CODE -ne 0 ]; then
          echo "‚ùå SECURITY GATE FAILED: High/Critical vulnerabilities detected!"
          exit 1
        else
          echo "‚úÖ SECURITY GATE PASSED: No critical vulnerabilities found."
          exit 0
        fi

